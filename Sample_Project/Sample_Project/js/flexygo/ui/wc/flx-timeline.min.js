var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxTimelineElement=class extends HTMLElement{constructor(){super(),this.timelineRanges={Hour:18e5,Day:432e5,Week:3456e5,Month:1296e6,Year:158112e5}}static get observedAttributes(){return["ModuleName"]}init(){try{let me=$(this);if(me.removeAttr("manualInit"),this.filterValues=null,this.activeFilter=null,this.wcParentModule=me.closest("flx-module")[0],!this.wcParentModule)throw flexygo.msg.error("flx-timeline has to be inside a flx-module"),"flx-timeline has to be inside a flx-module";let history=flexygo.history.get(me);if(history&&history.filtersValues&&history.filtersValues[this.wcParentModule.moduleName]){let filterHistoryValue=history.filtersValues[this.wcParentModule.moduleName];filterHistoryValue.activeFilter&&(this.activeFilter=filterHistoryValue.activeFilter),filterHistoryValue.properties&&(this.filterValues=filterHistoryValue.properties)}this.getTimeline()}catch(ex){console.error("FlexyGo Timeline",ex)}}refresh(){"true"!=$(this).attr("manualInit")&&this.init()}setFilter(){"true"!=$(this).attr("manualInit")&&this.getTimeline()}render(){try{let itemsWithoutGroup=`<aside id="items_without_group" class="folded">\n                                                        <div>\n                                                            <h4>${this.timelineSetting.TitleItemsWithoutGroup}</h4>\n                                                        </div>\n                                                        <div id="items-container"></div>\n                                                        <div class="fold"> \n                                                            <i class="flx-icon icon-arrow-head-5"/> \n                                                        </div>\n                                                    </aside>`,controls=`<div id="controls">\n                                            <div>                            \n                                                <button type="button" method="navigation" value="0.9"><i class="fa fa-angle-left"/></button>\n                                                <button type="button" method="today">${flexygo.localization.translate("flxtimeline.today")}</button>\n                                                <button type="button" method="navigation" value="-0.9" value="0.9"><i class="fa fa-angle-right"/></button>                           \n                                            </div>\n                                            <div>\n                                                <button type="button" method="changeRange" range="Hour" value="${this.timelineRanges.Hour}">${flexygo.localization.translate("flxtimeline.hour")}</button>\n                                                <button type="button" method="changeRange" range="Day" value="${this.timelineRanges.Day}">${flexygo.localization.translate("flxtimeline.day")}</button>\n                                                <button type="button" method="changeRange" range="Week" value="${this.timelineRanges.Week}">${flexygo.localization.translate("flxtimeline.week")}</button>\n                                                <button type="button" method="changeRange" range="Month" value="${this.timelineRanges.Month}">${flexygo.localization.translate("flxtimeline.month")}</button>\n                                                <button type="button" method="changeRange" range="Year" value="${this.timelineRanges.Year}">${flexygo.localization.translate("flxtimeline.year")}</button>\n                                            </div>\n                                        </div>`;$(this).html(`<section id="timeline_container" ShowControls="${this.timelineSetting.ShowControls}" layout=" ${this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup&&this.timelineSetting.LayoutName?this.timelineSetting.LayoutName:""}">\n                               ${this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup?itemsWithoutGroup:""}\n                                <div id="vis">\n                                ${this.timelineSetting.ShowControls?controls:""}                               \n                                </div>\n                            </section>`),flexygo.utils.isBlank(this.timelineSetting.DefaultRangeName)||$(this).find(`#controls > div > button[range="${this.timelineSetting.DefaultRangeName}"]`).addClass("active"),this.setStructureEvents()}catch(ex){console.log(ex)}}setStructureEvents(){let removeActiveRangeEvent=e=>{$(this).find("#controls > div > button.active").removeClass("active")},flagEventMousewheel=!1;this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup&&$(this).find("#items_without_group > div.fold").off("click.timeline").on("click.timeline",()=>{let itemsWithoutGroup=$(this).find("#items_without_group");itemsWithoutGroup.hasClass("folded")?itemsWithoutGroup.removeClass("folded"):itemsWithoutGroup.addClass("folded")}),$(document).off("keydown.timeline keyup.timeline").on({"keydown.timeline":e=>{e.shiftKey&&71===e.keyCode&&!this.visTimeline.itemSet.options.multiselectPerGroup&&this.visTimeline.setOptions({multiselectPerGroup:!0}),e.ctrlKey&&!flagEventMousewheel&&(flagEventMousewheel=!0,this.visTimeline.on("mousewheel",removeActiveRangeEvent))},"keyup.timeline":e=>{16!==e.keyCode&&71!==e.keyCode||!this.visTimeline.itemSet.options.multiselectPerGroup||this.visTimeline.setOptions({multiselectPerGroup:!1}),17===e.keyCode&&flagEventMousewheel&&(flagEventMousewheel=!1,this.visTimeline.off("mousewheel",removeActiveRangeEvent))}}),this.timelineSetting.ShowControls&&($(this).find("#controls > div > button").off("click.timeline").on("click.timeline",e=>{let element=$(e.currentTarget),method=element.attr("method"),value=parseFloat(element.attr("value")),range=this.visTimeline.getWindow();switch(method){case"navigation":let intervalArrows=range.end.getTime()-range.start.getTime();this.visTimeline.setWindow(range.start.valueOf()-intervalArrows*value,range.end.valueOf()-intervalArrows*value);break;case"today":this.visTimeline.moveTo(moment().format());break;case"changeRange":let interval=moment((range.start.getTime()+range.end.getTime())/2).format();this.visTimeline.setWindow(moment(interval).subtract(value,"millisecond"),moment(interval).add(value,"millisecond")),$(this).find("#controls > div > button.active").removeClass("active"),element.addClass("active")}}),$(this).find("#controls > div:nth-child(1)").tooltip({title:flexygo.localization.translate("flxtimeline.navigation"),placement:"right",trigger:"hover"}),$(this).find("#controls > div:nth-child(2)").tooltip({title:flexygo.localization.translate("flxtimeline.range"),placement:"right",trigger:"hover"}))}initVisTimeline(visItems,visGroups,visOptions={}){this.visTimeline=new vis.Timeline($(this).find("#timeline_container > #vis")[0],visItems,visGroups,visOptions)}setItemsWithoutGroups(visItems){if(0===visItems.length)$(this).find("#timeline_container > #items_without_group > #items-container").append(`<span>${flexygo.localization.translate("flxtimeline.withoutRegisters")}</span>`);else{for(const item of visItems){let visItemData=this.buildVisItem(item);$(`<div class="item ${flexygo.utils.isBlank(visItemData.className)?"":visItemData.className}" ${flexygo.utils.isBlank(visItemData.style)?"":`style="${visItemData.style}"`} draggable= "true"> \n                                                                                        ${this.timelineSetting.ItemContentTemplate?flexygo.utils.parser.recursiveCompile(item,this.timelineSetting.ItemContentTemplate):item[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip]} \n                                                                                     </div>`).appendTo($(this).find("#timeline_container > #items_without_group > #items-container"))[0].visItemData=visItemData}$(this).find("#timeline_container > #items_without_group > #items-container > .item").off("dragstart.timeline").on("dragstart.timeline",event=>{event.originalEvent.dataTransfer.effectAllowed="move",event.originalEvent.dataTransfer.setData("text",JSON.stringify(event.currentTarget.visItemData))})}}getTimeline(){let params={ModuleName:this.moduleName,searchId:this.activeFilter,filterValues:this.filterValues};flexygo.ajax.post("~/api/Timeline","GetTimeline",params,response=>{if(response){let visOptions,visItems=new vis.DataSet,visGroups=new vis.DataSet;this.timelineSetting=response.TimelineSetting,this.defaults=response.Defaults?response.Defaults:{},this.toolbar=response.Toolbar,this.searchSettings=response.SearchSettings,this.savedSearches=response.SavedSearches,this.render(),this.wcParentModule.setButtons(this.toolbar,this.timelineSetting.EntityConfiguration.CollectionName,response.FilterObjectWhere),this.loadFilters(),visOptions={editable:this.timelineSetting.Editable?{add:this.timelineSetting.EntityConfiguration.CanInsert,remove:this.timelineSetting.EntityConfiguration.CanDelete,updateGroup:this.timelineSetting.EntityConfiguration.CanUpdate&&this.timelineSetting.CanEditPropertyGroup,updateTime:this.timelineSetting.EntityConfiguration.CanUpdate&&(this.timelineSetting.CanEditPropertyStartDate||this.timelineSetting.CanEditPropertyEndDate),overrideItems:!1}:this.timelineSetting.Editable,end:moment().add(this.timelineRanges[this.timelineSetting.DefaultRangeName],"millisecond").format(),height:this.timelineSetting.ShowControls?"calc(100% - 42px)":"100%",locale:flexygo.context.currentUserLang,max:moment().add("years",25).format(),min:moment().add("years",-25).format(),multiselect:!0,onAdd:(item,callback)=>{this.objectActions(item,item.withOutGroup?"update":"insert").then(data=>{data&&$(this).find("#timeline_container > #items_without_group > #items-container > .item").filter((index,element)=>element.visItemData.id===data.id).remove(),callback(data)},function(error){callback(null),console.error("FlexyGo Timeline",error)})},onMove:(item,callback)=>{this.objectActions(item,"update").then(function(data){callback(data)},function(error){callback(null),console.error("FlexyGo Timeline",error)})},onRemove:(item,callback)=>{this.objectActions(item,"delete").then(function(data){callback(data)},function(error){callback(null),console.error("FlexyGo Timeline",error)})},onUpdate:(item,callback)=>{(void 0===item.editable||item.editable&&"boolean"==typeof item.editable||item.editable&&"object"==typeof item.editable&&(item.editable.updateGroup||item.editable.updateTime||item.editable.remove))&&this.objectActions(item,"edit").then(function(data){callback(data)},function(error){callback(null),console.error("FlexyGo Timeline",error)})},orientation:{axis:"top",item:"top"},start:moment().subtract(this.timelineRanges[this.timelineSetting.DefaultRangeName],"millisecond").format(),tooltipOnItemUpdateTime:{template:item=>`<span class="vis-onUpdateTime-tooltip-left"><i class="fa fa-hourglass-1"> ${moment(item.start).format("MM/DD/YYYY hh:mm")}</i></span>${item.end?`<span class="vis-onUpdateTime-tooltip-right"><i class="fa fa-hourglass-end"> ${moment(item.end).format("MM/DD/YYYY hh:mm")} </i></span>`:""}`},verticalScroll:!0,zoomKey:"ctrlKey",zoomMax:15768e7,zoomMin:6e4},this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.OnDropObjectOnItemFunction)&&(visOptions.onDropObjectOnItem=((objectData,item,callback)=>{new Function("objectData","item",`return new Promise((resolve, reject) => { try {${this.timelineSetting.OnDropObjectOnItemFunction}} catch (ex) { reject(ex); } });`).call(this,objectData,item).then(function(data){callback(data)},function(error){callback(item),console.error("FlexyGo Timeline","OnDropObjectOnItemFunction",error)})})),this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.OnMovingFunction)&&(visOptions.onMoving=((item,callback)=>{new Function("item",`return new Promise((resolve, reject) => { try {${this.timelineSetting.OnMovingFunction}} catch (ex) { reject(ex); } });`).call(this,item).then(function(data){callback(data)},function(error){callback(item),console.error("FlexyGo Timeline","onMovingFunction",error)})})),this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.ItemVisibleFrameTemplate)&&(visOptions.visibleFrameTemplate=((item,element)=>flexygo.utils.parser.recursiveCompile(item.data,this.timelineSetting.ItemVisibleFrameTemplate)));for(const item of response.Items.filter(item=>!(this.timelineSetting.WithGroups&&flexygo.utils.isBlank(item[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup]))))visItems.add(this.buildVisItem(item));if(this.timelineSetting.WithGroups)for(const group of response.Groups)visGroups.add(this.buildVisGroup(group));else visGroups=null;this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup&&this.setItemsWithoutGroups(response.Items.filter(item=>flexygo.utils.isBlank(item[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup]))),this.initVisTimeline(visItems,visGroups,visOptions)}})}buildVisItem(data){if(data){let id=new Array;return this.timelineSetting.EntityConfiguration.ObjectKeys.forEach(key=>id.push({[key]:data[key]})),{id:JSON.stringify(id),group:data[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup],content:this.timelineSetting.ItemContentTemplate?flexygo.utils.parser.recursiveCompile(data,this.timelineSetting.ItemContentTemplate):data[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip]?data[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip]:flexygo.localization.translate("flxtimeline.withoutDescription"),start:moment(data[this.timelineSetting.Advanced?this.timelineSetting.ItemStartDateField:this.timelineSetting.PropertyStartDate]).toDate(),end:data[this.timelineSetting.Advanced?this.timelineSetting.ItemEndDateField:this.timelineSetting.PropertyEndDate]?moment(data[this.timelineSetting.Advanced?this.timelineSetting.ItemEndDateField:this.timelineSetting.PropertyEndDate]).toDate():null,title:data[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip],withOutGroup:!data[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup],editable:this.timelineSetting.Advanced&&this.timelineSetting.Editable&&this.checkEditableProperty(data[this.timelineSetting.ItemEditableField])?JSON.parse(data[this.timelineSetting.ItemEditableField]):void 0,className:this.timelineSetting.Advanced?data[this.timelineSetting.ItemClassNameField]:null,style:this.timelineSetting.Advanced?data[this.timelineSetting.ItemStyleField]:null,type:this.timelineSetting.Advanced?data[this.timelineSetting.ItemTypeField]:null,data}}return null}buildVisGroup(data){return data?{id:data[this.timelineSetting.GroupIdField]||data[this.timelineSetting.PropertyGroup],content:this.timelineSetting.GroupContentTemplate?flexygo.utils.parser.recursiveCompile(data,this.timelineSetting.GroupContentTemplate):data[this.timelineSetting.GroupDescripField]||data[this.timelineSetting.PropertyGroup],className:this.timelineSetting.Advanced?data[this.timelineSetting.GroupClassNameField]:null,style:this.timelineSetting.Advanced?data[this.timelineSetting.GroupStyleField]:null,data}:null}objectActions(object,action){return new Promise((resolve,reject)=>{try{let objectEntity=new flexygo.obj.Entity(this.timelineSetting.EntityConfiguration.ObjectName,this.hasIdStructure(object.id.toString())?this.getObjectWhere(JSON.parse(object.id.toString())):null);switch(action){case"insert":case"edit":case"update":"insert"===action&&this.timelineSetting.OnInsertOpenNewWithDefaults||"edit"===action?this.openObjectEdit(object,objectEntity).then(function(data){resolve(data)},function(error){throw error}):objectEntity.read()?($.extend(!0,objectEntity.data,{[this.timelineSetting.PropertyGroup]:this.timelineSetting.WithGroups&&this.timelineSetting.PropertyGroup?{Value:object.group}:void 0,[this.timelineSetting.PropertyStartDate]:{Value:object.start},[this.timelineSetting.PropertyEndDate]:this.timelineSetting.PropertyEndDate?{Value:object.end}:void 0}),resolve(("insert"===action?objectEntity.insert():objectEntity.update())?this.buildVisItem(objectEntity.getView(this.timelineSetting.Advanced?this.timelineSetting.ItemViewName:null)[0]):null)):resolve(null);break;case"delete":resolve(objectEntity.delete()?object:null);break;default:resolve(null)}}catch(ex){reject(ex)}})}openObjectEdit(object,objectEntity){return new Promise((resolve,reject)=>{try{flexygo.nav.openPage("edit",objectEntity.objectName,objectEntity.objectWhere,JSON.stringify(Object.assign(this.defaults,{[this.timelineSetting.PropertyStartDate]:object.start,[this.timelineSetting.PropertyEndDate]:this.timelineSetting.PropertyEndDate?object.end:void 0,[this.timelineSetting.PropertyGroup]:this.timelineSetting.WithGroups&&this.timelineSetting.PropertyGroup?object.group:void 0})),"modal"),flexygo.events.on(this,"entity","all",e=>{this===e.context&&e.sender.objectName===objectEntity.objectName&&(flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),"deleted"===e.type?(resolve(null),this.visTimeline.itemsData.remove(object.id)):resolve(this.buildVisItem(e.sender.getView(this.timelineSetting.Advanced?this.timelineSetting.ItemViewName:null)[0])),flexygo.nav.closePage($('flx-edit[objectname="'+objectEntity.objectName+'"]')))}),flexygo.events.on(this,"dialog","closed",e=>{this===e.context&&e.sender.objectname===objectEntity.objectName&&(flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),resolve(null))})}catch(ex){reject(ex)}})}getObjectWhere(id){let where="";return id.forEach((value,index)=>{where+=`[${this.timelineSetting.EntityConfiguration.TableName}].[${Object.keys(value)[0]}] = '${value[Object.keys(value)[0]]}'${index<id.length-1?" AND ":""}`}),where}hasIdStructure(id){try{return!!isNaN(JSON.parse(id))}catch(e){return!1}}isJson(json){try{JSON.parse(json)}catch(e){return!1}return!0}checkEditableProperty(valueJson){let value;if(this.isJson(valueJson)){if("boolean"==typeof(value=JSON.parse(valueJson)))return!0;if("object"==typeof value){for(const key of["updateGroup","updateTime","remove"])if(key in value)return!0;return!1}return!1}return!1}loadFilters(){if(this.searchSettings){let pane=$(this.wcParentModule).find(".cntBodyHeader .filterPanel"),filter=$("<flx-filter></flx-filter>"),wcFilter=filter[0];0==pane.length&&this.toolbar&&Object.keys(this.toolbar).length>0&&(pane=$('<div class="filterPanel"/>'),$(this.wcParentModule).find(".cntBodyHeader").append(pane)),pane.html(filter),wcFilter&&(wcFilter.settings=this.searchSettings,wcFilter.key=this.timelineSetting.EntityConfiguration.ObjectName+"-"+this.moduleName,wcFilter.grid=this,wcFilter.init())}}configure(){flexygo.nav.openPage("edit","sysTimeline_Setting",`[Timelines_Settings].[TimelineSettingName]='${this.timelineSetting.TimelineSettingName}'`,null,"popup",!0)}connectedCallback(){let element=$(this);this.connected=!0,this.moduleName=element.attr("ModuleName"),"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),$(document).off("keydown.timeline keyup.timeline")}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,needInit=!0),this.connected&&needInit&&this.init()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-timeline",flexygo.ui.wc.FlxTimelineElement);